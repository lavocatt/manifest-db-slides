<!DOCTYPE html>
<html>
  <head>
    <title>Manifest-DB</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
  </head>
  <body>
    <textarea id="source">

class:  middle

# Manifest-DB Demo

## Agenda

1. Introduction
2. The way we did before Manifest-DB
3. With the Manifest-DB repository
4. Demo time

---

class: center, middle

# Introduction

![](https://mermaid.ink/svg/pako:eNo9j70OwjAMhF_F8kxfoAMTDJXoAiPpYBqnWGoclDpCCPHuhN_NJ393p7vjmDxji2FO1_FM2WC3d9odu0gTg-cgKiZJB2iaiRUiqQRerGnW0B_7rxqc9hWAtJyKzB5e3y5-Q0RDGnCFkXMk8bXs7hTAoZ05ssO2nrWIymwOnT4qWi6ejLdeLGVsA80Lr5CKpcNNR2wtF_5BG6EpU_xT_Db1n1XvcY8nBzNOUA)

---

## Image definitions

- Way to describe an image

- Exist for every image we support

Definitions can be found in [osbuild-composer/internal/distros](https://github.com/osbuild/osbuild-composer/tree/main/internal/distro)

### Image definitions must be tested

- Run OSBuild against every of them
- Check the build is *correct*
    - Absence of accidental change
    - Validate changes on a rare occasion

OSBuild can't run the image definition directly.
It needs an intermediate format, the
[manifest](https://github.com/osbuild/manifest-db/blob/main/manifest-db/centos_8-aarch64-ami-boot.json#L8)


---

## Manifests

The Manifest is JSON representation of an image definition. It tells OSBuild
what to do to make an Image

## Image info

The [Image info](https://github.com/osbuild/manifest-db/blob/main/manifest-db/centos_8-aarch64-ami-boot.json#L6868) is a JSON representation of an image

Generated by the tool
[`image-info`](https://github.com/osbuild/manifest-db/blob/main/tools/image-info)
it contains a list of discoverable pieces of information such as:
- Package list
- Network configuration
- ...

## Test cases

Combination of manifest and image-info. They are the reference point of what is
`correct` for a given input. They must be generated and stored for later use

---


## Test cases generation

### Manifests

With a stable version of Composer, a manifest is
[generated](https://github.com/osbuild/osbuild-composer/tree/main/cmd/gen-manifests)
for each image definition
- Easy to run, consume few
[resources](https://github.com/osbuild/manifest-db/blob/main/.gitlab-ci.yml#L58)

### Image info

With a stable version of OSBuild

* Generate an image for each manifest
* Generate an image info for each image

Generation is a [heavy duty
task](https://github.com/osbuild/manifest-db/blob/main/.gitlab-ci.yml#L75):

- Requires a machine per `arch+distro`
- And up to
[2h10](https://gitlab.com/redhat/services/products/image-builder/ci/manifest-db/-/jobs/3119412435) to build a set of manifests on a machine


---

class: center, middle

# The way we did before Manifest-DB

---

### Generation is manual

#### Meaning

- in depth knowledge of our toolchain is required
- access to internal network for rhel distributions
- access to specialized hardware (ppc)

As a result, its not accessible especially for external developers
(that prevents them from contributing to image definitions)

### The tests and their cases are stored on Composer

As their main purpose is to test the non regression of OSBuild (using
[image_test](https://github.com/osbuild/osbuild-composer/blob/main/test/cases/image_tests.sh))
they should not belong in Composer


---

class: center, middle

# With the Manifest-DB repository

---

### Automation

#### Updating the DB, CI job

- [Generates the manifests](https://github.com/osbuild/manifest-db/blob/main/.gitlab-ci.yml#L68)
- [Runs OSBuild on
them](https://github.com/osbuild/manifest-db/blob/main/test/cases/manifest_tests#L27)
- [Generates the image
info](https://github.com/osbuild/manifest-db/blob/main/tools/osbuild-image-test#L274)
and [updates the DB](https://github.com/osbuild/manifest-db/blob/main/.gitlab-ci.yml#L117)
- [Sends](https://github.com/osbuild/manifest-db/blob/main/schutzbot/include_image_info.sh#L33)
a [PR](https://github.com/osbuild/manifest-db/pull/55) (tooling for
reviewers [`tools/update_tool`](https://github.com/osbuild/manifest-db/pull/42))

Note: you can add yourself to the [list of reviewers](https://github.com/osbuild/manifest-db/blob/main/schutzbot/include_image_info.sh#L37) if you want to get notified

#### Keeping toolchain up to date

- [GH action](https://github.com/osbuild/manifest-db/blob/main/.github/workflows/propagate_to_osbuild.yml) to update OSBuild's reference commit
- [GH action](https://github.com/osbuild/osbuild/blob/main/.github/workflows/propagate_to_manifestdb.yml) to update Manifest-DB's reference commit

### The tests and their cases are stored on Manifest-DB

- test in [`tools/osbuild-image-test`](https://github.com/osbuild/manifest-db/tree/main/tools/osbuild-image-test)
- data in the [`manifest-db`](https://github.com/osbuild/manifest-db/tree/main/manifest-db) directory


---

class: center, middle

# Demo time

Let's review an [update](https://github.com/osbuild/manifest-db/pull/55) together

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>
